<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Feedback</title>
    <link rel="stylesheet" href="customer-ui-style.css">
</head>
<body class="page-content">
    <div id="i6po" class="gjs-grid-row">
        <div id="itjq" class="gjs-grid-column">
            <div id="iyd2">
                <div>
                    <a href="index.html">
                        <img id="ihtxj" src="assets/acaccia_logo.png" alt="Acaccia Logo" />
                    </a>
                </div>
                <button id="mobile-menu-toggle">
        <span></span>
        <span></span>
        <span></span>
    </button>
                <div id="it00l">
                    <div class="nav-links">
                        <a href="index.html">Home</a>
                        <a href="menu.html">Menu</a>
                        <a href="reservation.html">Reservation</a>
                        <a href="community-feedback.html">Community</a>
                    </div>
                </div>
<div class="header-controls">
    
    <div id="notification-bell" class="notification-bell" style="display: none;">
        <span>üîî</span>
        <div id="notification-badge" class="notification-badge hidden">0</div>
        <div id="notification-panel" class="notification-panel hidden">
            <div class="notification-panel-header">
                <h3>Notifications</h3>
            </div>
            <ul id="notification-list">
                <li class="notification-none">Loading...</li>
            </ul>
        </div>
    </div>

    <a id="i1mew" class="cta-button" href="login.html" style="padding: 10px 20px; text-transform: uppercase; font-family: var(--font-body); font-size: 0.85rem; letter-spacing: 1.5px; font-weight: 700; background-color: var(--color-gold); color: white; text-decoration: none; border-radius: var(--radius-md); transition: var(--transition-fast);">Login/Sign up</a>

    <div class="profile-avatar-container" id="profile-avatar-container" style="display: none;">
        <div class="profile-avatar" id="profile-avatar">
            <span id="profile-initials">--</span>
        </div>
        <div class="profile-dropdown" id="profile-dropdown">
            <div class="dropdown-item" id="open-my-reservation-btn">My Reservation</div>
            <div class="dropdown-item" id="open-account-settings-btn">Account Settings</div>
            <div class="dropdown-item" id="profile-logout-btn">Logout</div>
        </div>
    </div>
    
</div>
            </div>
        </div>
    </div>

    <div class="community-background">
        <div class="community-section">
            <h2>Community Bulletin Board</h2>
                    <div class="bulletin-instructions">
                    <p>üñºÔ∏è Click on any empty spot to add your photo and review!</p>
                    <p>üìå Share your cafe moments with the community</p>
                </div>
            
            <div class="bulletin-board-main">
                <div class="bulletin-board-container-large" id="bulletinBoardContainer">
                    <img src="./assets/bulletin_board_bg.png" alt="Cafe Bulletin Board" class="bulletin-board-image" id="bulletinBoardImage" 
                         onload="this.style.display='block'; document.getElementById('bulletinPlaceholder').style.display='none';" 
                         onerror="window.showBulletinPlaceholder()">
                    
                    <div class="bulletin-placeholder" id="bulletinPlaceholder">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-1 16H9V7h9v14z"/>
                        </svg>
                        <h3>Community Bulletin Board</h3>
                        <p>Share your cafe experiences and photos here!</p>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">Showing approved feedback from the last 7 days</p>
                    </div>
                    
                    <div class="photo-spots" id="photoSpots">
                        <div class="photo-spot" id="spot1" style="top: 20%; left: 30%; transform: translate(-50%, -50%) rotate(-8deg);" onclick="openPhotoModal(1)">
                            <div class="photo-placeholder-spot"><span>üì∑</span><p>Click to add photo</p></div>
                        </div>
                        <div class="photo-spot" id="spot2" style="top: 25%; left: 50%; transform: translate(-50%, -50%) rotate(5deg);" onclick="openPhotoModal(2)">
                            <div class="photo-placeholder-spot"><span>üì∑</span><p>Click to add photo</p></div>
                        </div>
                        <div class="photo-spot" id="spot3" style="top: 22%; left: 70%; transform: translate(-50%, -50%) rotate(-5deg);" onclick="openPhotoModal(3)">
                            <div class="photo-placeholder-spot"><span>üì∑</span><p>Click to add photo</p></div>
                        </div>
                        <div class="photo-spot" id="spot4" style="top: 45%; left: 20%; transform: translate(-50%, -50%) rotate(10deg);" onclick="openPhotoModal(4)">
                            <div class="photo-placeholder-spot"><span>üì∑</span><p>Click to add photo</p></div>
                        </div>
                        <div class="photo-spot" id="spot5" style="top: 40%; left: 40%; transform: translate(-50%, -50%) rotate(-3deg);" onclick="openPhotoModal(5)">
                            <div class="photo-placeholder-spot"><span>üì∑</span><p>Click to add photo</p></div>
                        </div>
                        <div class="photo-spot" id="spot6" style="top: 42%; left: 60%; transform: translate(-50%, -50%) rotate(4deg);" onclick="openPhotoModal(6)">
                            <div class="photo-placeholder-spot"><span>üì∑</span><p>Click to add photo</p></div>
                        </div>
                        <div class="photo-spot" id="spot7" style="top: 48%; left: 80%; transform: translate(-50%, -50%) rotate(-7deg);" onclick="openPhotoModal(7)">
                            <div class="photo-placeholder-spot"><span>üì∑</span><p>Click to add photo</p></div>
                        </div>
                        <div class="photo-spot" id="spot8" style="top: 65%; left: 30%; transform: translate(-50%, -50%) rotate(-5deg);" onclick="openPhotoModal(8)">
                            <div class="photo-placeholder-spot"><span>üì∑</span><p>Click to add photo</p></div>
                        </div>
                        <div class="photo-spot" id="spot9" style="top: 68%; left: 50%; transform: translate(-50%, -50%) rotate(8deg);" onclick="openPhotoModal(9)">
                            <div class="photo-placeholder-spot"><span>üì∑</span><p>Click to add photo</p></div>
                        </div>
                        <div class="photo-spot" id="spot10" style="top: 70%; left: 70%; transform: translate(-50%, -50%) rotate(-2deg);" onclick="openPhotoModal(10)">
                            <div class="photo-placeholder-spot"><span>üì∑</span><p>Click to add photo</p></div>
                        </div>
                        <div class="photo-spot" id="spot11" style="top: 85%; left: 40%; transform: translate(-50%, -50%) rotate(6deg);" onclick="openPhotoModal(11)">
                            <div class="photo-placeholder-spot"><span>üì∑</span><p>Click to add photo</p></div>
                        </div>
                        <div class="photo-spot" id="spot12" style="top: 82%; left: 60%; transform: translate(-50%, -50%) rotate(-9deg);" onclick="openPhotoModal(12)">
                            <div class="photo-placeholder-spot"><span>üì∑</span><p>Click to add photo</p></div>
                        </div>
                    </div>
                    </div>
                

            </div>
            
            <div class="photo-modal" id="photoModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üì∏ Share Your Cafe Experience</h3>
                        <button class="modal-close" onclick="closePhotoModal()">&times;</button>
                    </div>
                     <form id="photoSubmissionForm" onsubmit="submitPhotoToBulletin(event)">
                        
                        <div class="form-group">
                            <label for="modalPhotoInput">Choose Your Photo:</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="modalPhotoInput" class="file-input" accept="image/*" onchange="previewModalPhoto(event)" required>
                                <label for="modalPhotoInput" class="file-input-label">
                                    üì∑ Select Photo
                                </label>
                                <img id="modalPhotoPreview" class="photo-preview-modal" alt="Photo preview">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Your Ratings:</label>
                            
                            <div class="rating-criteria-group">
                                <label for="rating-quality">Product Quality</label>
                                <div class="star-rating" id="rating-quality">
                                    <input type="radio" name="rating-quality" id="quality-5" value="5" required><label for="quality-5">‚òÖ</label>
                                    <input type="radio" name="rating-quality" id="quality-4" value="4" required><label for="quality-4">‚òÖ</label>
                                    <input type="radio" name="rating-quality" id="quality-3" value="3" required><label for="quality-3">‚òÖ</label>
                                    <input type="radio" name="rating-quality" id="quality-2" value="2" required><label for="quality-2">‚òÖ</label>
                                    <input type="radio" name="rating-quality" id="quality-1" value="1" required><label for="quality-1">‚òÖ</label>
                                </div>
                            </div>
                            
                            <div class="rating-criteria-group">
                                <label for="rating-service">Service Experience</label>
                                <div class="star-rating" id="rating-service">
                                    <input type="radio" name="rating-service" id="service-5" value="5" required><label for="service-5">‚òÖ</label>
                                    <input type="radio" name="rating-service" id="service-4" value="4" required><label for="service-4">‚òÖ</label>
                                    <input type="radio" name="rating-service" id="service-3" value="3" required><label for="service-3">‚òÖ</label>
                                    <input type="radio" name="rating-service" id="service-2" value="2" required><label for="service-2">‚òÖ</label>
                                    <input type="radio" name="rating-service" id="service-1" value="1" required><label for="service-1">‚òÖ</label>
                                </div>
                            </div>
                            
                            <div class="rating-criteria-group">
                                <label for="rating-ambience">Ambience & Cleanliness</label>
                                <div class="star-rating" id="rating-ambience">
                                    <input type="radio" name="rating-ambience" id="ambience-5" value="5" required><label for="ambience-5">‚òÖ</label>
                                    <input type="radio" name="rating-ambience" id="ambience-4" value="4" required><label for="ambience-4">‚òÖ</label>
                                    <input type="radio" name="rating-ambience" id="ambience-3" value="3" required><label for="ambience-3">‚òÖ</label>
                                    <input type="radio" name="rating-ambience" id="ambience-2" value="2" required><label for="ambience-2">‚òÖ</label>
                                    <input type="radio" name="rating-ambience" id="ambience-1" value="1" required><label for="ambience-1">‚òÖ</label>
                                </div>
                            </div>
                            
                            <div class="rating-criteria-group">
                                <label for="rating-value">Value for Money</label>
                                <div class="star-rating" id="rating-value">
                                    <input type="radio" name="rating-value" id="value-5" value="5" required><label for="value-5">‚òÖ</label>
                                    <input type="radio" name="rating-value" id="value-4" value="4" required><label for="value-4">‚òÖ</label>
                                    <input type="radio" name="rating-value" id="value-3" value="3" required><label for="value-3">‚òÖ</label>
                                    <input type="radio" name="rating-value" id="value-2" value="2" required><label for="value-2">‚òÖ</label>
                                    <input type="radio" name="rating-value" id="value-1" value="1" required><label for="value-1">‚òÖ</label>
                                </div>
                            </div>
                            
                            <div class="rating-criteria-group">
                                <label for="rating-overall">Overall Experience</label>
                                <div class="star-rating" id="rating-overall">
                                    <input type="radio" name="rating-overall" id="overall-5" value="5" required><label for="overall-5">‚òÖ</label>
                                    <input type="radio" name="rating-overall" id="overall-4" value="4" required><label for="overall-4">‚òÖ</label>
                                    <input type="radio" name="rating-overall" id="overall-3" value="3" required><label for="overall-3">‚òÖ</label>
                                    <input type="radio" name="rating-overall" id="overall-2" value="2" required><label for="overall-2">‚òÖ</label>
                                    <input type="radio" name="rating-overall" id="overall-1" value="1" required><label for="overall-1">‚òÖ</label>
                                </div>
                            </div>

                        </div>

                        <div class="form-group">
                            <label for="modalReviewText">Your Review:</label>
                            <textarea id="modalReviewText" placeholder="Share your experience at Acaccia Bistro Cafe..." required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="modalUserName">Your Name:</label>
                            <input type="text" id="modalUserName" placeholder="How should we credit you?" required>
                        </div>
                        
                        <button type="submit" class="submit-btn" id="photo-submit-btn">Pin to Bulletin Board</button>

                    </form>
                </div>
            </div>
        </div>
    </div>
<div id="auth-validation-modal" class="auth-modal-backdrop hidden">
        <div class="auth-modal-content">
            <h2>Login Required</h2>
            <p>You must be logged in to post on the bulletin board. Please log in or create an account to continue.</p>
            <div class="auth-modal-buttons">
                <a href="login.html" class="auth-modal-btn">Login</a>
                <a href="login.html" class="auth-modal-btn auth-modal-btn-secondary">Sign Up</a>
            </div>
            <div class="auth-modal-tertiary-action">
            <button type="button" class="auth-modal-btn-tertiary auth-modal-close-btn">Stay signed out</button>
        </div>
        </div>
    </div>
    <div id="my-reservation-modal" class="auth-modal-backdrop hidden">
    <div class="auth-modal-content" style="max-width: 500px; text-align: left;">
        <h2 style="text-align: center;">My Active Reservation</h2>
        
        <div id="reservation-details-content">
            <div style="background: #f8f9fa; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: 20px; margin-top: 20px;">
                <p><strong>Reservation ID:</strong> <span id="my-res-id">...</span></p>
                <p><strong>Date:</strong> <span id="my-res-date">...</span></p>
                <p><strong>Time:</strong> <span id="my-res-time">...</span></p>
                <p><strong>Table:</strong> <span id="my-res-table">...</span></p>
                <p><strong>Diners:</strong> <span id="my-res-diners">...</span></p>
                <p><strong>Status:</strong> <span id="my-res-status" style="font-weight: 700;">...</span></p>
                
                <h4 style="margin-top: 15px; border-top: 1px solid var(--color-border); padding-top: 15px;">Pre-Order Summary</h4>
                <div id="my-res-items" style="font-size: 0.9rem; max-height: 150px; overflow-y: auto;">
                    </div>
            </div>
            
            <div id="my-res-warning" class="reschedule-warning hidden" style="margin-top: 15px;">
                </div>
            
            <div class="auth-modal-buttons" style="margin-top: 25px; gap: 10px;">
                <button type="button" id="my-res-view-receipt-btn" class="auth-modal-btn auth-modal-btn-secondary">View Receipt</button>
                <button type="button" id="my-res-reschedule-btn" class="auth-modal-btn">Reschedule</button>
            </div>
        </div>
        
        <div id="no-reservation-content" class="hidden">
            <p style="text-align: center; margin-top: 20px;">You have no active reservations.</p>
            <div class="auth-modal-buttons" style="margin-top: 25px;">
                <a href="reservation.html" class="auth-modal-btn">Book a Table</a>
            </div>
        </div>

        <div class="auth-modal-tertiary-action" style="margin-top: 15px;">
            <button type="button" class="auth-modal-btn-tertiary" id="close-my-reservation-modal-btn">Close</button>
        </div>
    </div>
</div>

<div id="account-settings-modal" class="auth-modal-backdrop hidden">
    <div class="auth-modal-content" style="max-width: 500px; text-align: left;">
        <h2 style="text-align: center;">Account Settings</h2>
        
        <form id="change-name-form">
            <h4 style="margin-top: 10px;">Change Your Name</h4>
            <div class="form-group">
                <label for="account-full-name">Full Name</label>
                <input type="text" id="account-full-name" class="form-control" required>
            </div>
            <button type="submit" class="auth-modal-btn" style="width: 100%;">Save Name</button>
        </form>
        
        <hr style="margin: 25px 0; border: 0; border-top: 1px solid var(--color-border);">
        
        <form id="change-password-form">
            <h4 style="margin-top: 10px;">Change Password</h4>
            <div class="form-group">
                <label for="account-current-password">Current Password</label>
                <input type="password" id="account-current-password" class="form-control" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="form-group">
                <label for="account-new-password">New Password</label>
                <input type="password" id="account-new-password" class="form-control" required placeholder="At least 6 characters">
            </div>
            <div class="form-group">
                <label for="account-confirm-password">Confirm New Password</label>
                <input type="password" id="account-confirm-password" class="form-control" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button type="submit" class="auth-modal-btn" style="width: 100%;">Change Password</button>
        </form>

        <div class="auth-modal-tertiary-action" style="margin-top: 15px;">
            <button type="button" class="auth-modal-btn-tertiary" id="close-account-settings-modal-btn">Close</button>
        </div>
    </div>
</div>

<footer id="iv3be5" class="gjs-grid-row">
    <footer id="iv3be5" class="gjs-grid-row">
        <div id="ilriti" class="gjs-grid-column">
            <div id="im0rle">
                <div>
                    <a href="index.html">
                        <img id="ikhs8g" src="https://cdn.grapesjs.com/workspaces/cmfdeh7by2aaty0i3kbmgsflu/assets/bc3511d6-050e-47d3-bc04-602f13480d07__acaccialogo.jpg" alt="Acaccia Logo" />
                    </a>
                </div>
                <div class="footer-column">
                    <h3>Acaccia Bistro Cafe</h3>
                    <a>Alaminos, Laguna</a>
                    <a>09123456789</a>
                    <a>www.Cafesync.com</a>
                </div>
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <a href="index.html">Home</a>
                    <a href="menu.html">Menu</a>
                    <a href="reservation.html">Reservations</a>
                    <a href="community-feedback.html">Community</a>
                    <a href="#">About Us</a>
                </div>
                <div class="footer-column">
                    <h3>Social Media</h3>
                    <a href="https://www.facebook.com/profile.php?id=61561806667727">Facebook</a>
                    <a href="https://www.instagram.com/acacciabistrocafe/">Instagram</a>
                    <a href="#">TikTok</a>
                </div>
            </div>
            <div class="gjs-divider"></div>
            <div id="it6g1v">Copyright ¬© 2025 Acaccia Bistro Cafe</div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var toggleBtn = document.getElementById('mobile-menu-toggle');
            var menu = document.getElementById('it00l'); // This is the container for .nav-links
    
            if (toggleBtn && menu) {
                toggleBtn.addEventListener('click', function() {
                    // Toggle the 'X' animation on the button
                    this.classList.toggle('is-active');
                    
                    // Toggle the dropdown menu visibility
                    menu.classList.toggle('mobile-menu-active');
                });
            }
        });
    </script>
<script type="module">
import { db } from "./scripts/firebase.js";
import {
  collection,
  addDoc,
  serverTimestamp,
  getDocs,
  query,
  orderBy,
  doc,
  getDoc,
  Timestamp,
  where 
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

// Global Firestore references
const feedbackCollection = collection(db, "customerFeedback");
let hasUnsavedChanges = false;
// Global state
let selectedSpot = null;
let bulletinPhotos = {}; // Stores data for the spots
let loggedInUser = null;
// let selectedRating = null; // No longer needed
let currentImageFile = null; // Stores the file object

// --- Constant for total spots ---
const TOTAL_SPOTS = 12; 

// ----------------------------
// Cloudinary Upload Function
// ----------------------------
async function uploadToCloudinary(file) {
    // --- ‚¨áÔ∏è ‚¨áÔ∏è VITAL: REPLACE THESE WITH YOUR OWN ‚¨áÔ∏è ‚¨áÔ∏è ---
    const CLOUD_NAME = "dofyjwhlu"; // <-- REPLACE WITH YOUR CLOUD_NAME
    const UPLOAD_PRESET = "cafesync"; // <-- REPLACE WITH YOUR UPLOAD_PRESET
    // --- ‚¨ÜÔ∏è ‚¨ÜÔ∏è VITAL: REPLACE THESE WITH YOUR OWN ‚¨ÜÔ∏è ‚¨ÜÔ∏è ---

    const URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);

    try {
        const response = await fetch(URL, {
            method: "POST",
            body: formData
        });
        if (!response.ok) {
            throw new Error(`Cloudinary upload failed with status: ${response.status}`);
        }
        const data = await response.json();
        return data.secure_url; // This is the URL to save to Firestore
    } catch (error) {
        console.error("Error uploading to Cloudinary:", error);
        throw error;
    }
}

// ----------------------------
// Bulletin Board Logic
// ----------------------------

// Fallback for broken bulletin board image
window.showBulletinPlaceholder = function() {
  document.getElementById('bulletinBoardImage').style.display = 'none';
  document.getElementById('bulletinPlaceholder').style.display = 'flex';
};

// Open upload modal
function openPhotoModal(spotNumber) {
    if (!loggedInUser) {
      const authModal = document.getElementById('auth-validation-modal');
      if (authModal) authModal.classList.remove('hidden');
      return; // Stop the function from continuing
  }
  // Don't open modal if spot is already filled
  if (bulletinPhotos[spotNumber]) {
      viewPhotoDetails(spotNumber);
      return;
  }
  
  selectedSpot = spotNumber;
  document.getElementById('photoModal').style.display = 'block';
  document.getElementById('photoSubmissionForm').reset();
  document.getElementById('modalPhotoPreview').style.display = 'none';
  currentImageFile = null;
 hasUnsavedChanges = false;

  // --- MODIFICATION: Reset new star ratings ---
  document.querySelectorAll('.star-rating input').forEach(radio => radio.checked = false);
  
  // Pre-fill user name if logged in
  const userNameInput = document.getElementById('modalUserName');
  if (loggedInUser) {
      userNameInput.value = loggedInUser.fullName;
      userNameInput.readOnly = true;
  } else {
      userNameInput.value = "";
      userNameInput.readOnly = false;
  }
}

// Close modal
function closePhotoModal() {
  document.getElementById('photoModal').style.display = 'none';
  selectedSpot = null;
  hasUnsavedChanges = false;
}

// Preview uploaded photo
function previewModalPhoto(event) {
  const file = event.target.files[0];
  const preview = document.getElementById('modalPhotoPreview');
  if (file) {
    if (file.size > 5 * 1024 * 1024) { // 5MB limit
      alert('Please choose an image smaller than 5MB.');
      event.target.value = '';
      preview.style.display = 'none';
      currentImageFile = null;
      return;
    }
    currentImageFile = file; // Store the file
    const reader = new FileReader();
    reader.onload = e => {
      preview.src = e.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  } else {
    preview.style.display = 'none';
    currentImageFile = null;
  }
}

// Submit Photo (NOW with Cloudinary + Star Ratings)
async function submitPhotoToBulletin(event) {
  event.preventDefault();

  if (!selectedSpot) {
    alert('Error: No spot selected.');
    return;
  }

  // --- MODIFICATION: Get all 5 star ratings ---
  const ratings = {
      quality: document.querySelector('input[name="rating-quality"]:checked')?.value,
      service: document.querySelector('input[name="rating-service"]:checked')?.value,
      ambience: document.querySelector('input[name="rating-ambience"]:checked')?.value,
      value: document.querySelector('input[name="rating-value"]:checked')?.value,
      overall: document.querySelector('input[name="rating-overall"]:checked')?.value,
  };

  // --- MODIFICATION: Validate all 5 ratings ---
  if (!ratings.quality || !ratings.service || !ratings.ambience || !ratings.value || !ratings.overall) {
      alert('Please select a star rating for all 5 criteria.');
      return;
  }

  const reviewText = document.getElementById('modalReviewText').value.trim();
  const userName = document.getElementById('modalUserName').value.trim();

  if (!currentImageFile) {
    alert('Please select a photo.');
    return;
  }
  if (!reviewText) {
    alert('Please write a review.');
    return;
  }
  if (!userName) {
    alert('Please enter your name.');
    return;
  }

  const submitBtn = document.getElementById('photo-submit-btn');
  submitBtn.disabled = true;
  submitBtn.textContent = "Uploading Image...";

  try {
    // 1. Upload image to Cloudinary
    const imageUrl = await uploadToCloudinary(currentImageFile);
    
    submitBtn.textContent = "Saving Feedback...";
    
    // --- MODIFICATION: Save data (including URL and ratings object) to Firestore ---
    const feedbackData = {
      name: userName,
      comment: reviewText,
      imageUrl: imageUrl, // <-- Save Cloudinary URL
      ratings: ratings, // <-- Save new ratings object
      timestamp: serverTimestamp(),
      status: "pending", // All new feedback is pending approval
      userId: loggedInUser ? loggedInUser.uid : null
    };

    await addDoc(feedbackCollection, feedbackData);
    hasUnsavedChanges = false;
    console.log("‚úÖ Feedback saved (pending approval):", feedbackData);

    closePhotoModal();
    showSuccessMessage('Your review was submitted for approval!');

  } catch (error) {
    console.error("‚ùå Error submitting feedback:", error);
    alert("Error submitting review. Please try again.");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "Pin to Bulletin Board";
  }
}

// Update the photo spot UI
function updatePhotoSpot(spotNumber, photoData) {
  const spot = document.getElementById(`spot${spotNumber}`);
  if (!spot) return;

  spot.classList.add('filled');
  
  spot.innerHTML = `
    <img src="${photoData.imageUrl}" 
         alt="Community photo" 
         class="submitted-photo" 
         style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
  `;

  spot.onclick = () => viewPhotoDetails(spotNumber);
}

// View photo details
function viewPhotoDetails(spotNumber) {
  const photoData = bulletinPhotos[spotNumber];
  if (!photoData) return;

  // --- MODIFICATION: Build ratings HTML ---
  let ratingsHTML = '';
  if (photoData.ratings) {
      // Helper function to generate star strings
      const createStars = (ratingVal) => {
          const rating = parseInt(ratingVal, 10);
          const star = '‚òÖ';
          const emptyStar = '‚òÜ';
          return `<span class="rating-display-stars">${star.repeat(rating)}${emptyStar.repeat(5 - rating)}</span>`;
      };
      
      ratingsHTML = `
          <div class="rating-display-group">
              <span>Product Quality:</span> ${createStars(photoData.ratings.quality)}
          </div>
          <div class="rating-display-group">
              <span>Service Experience:</span> ${createStars(photoData.ratings.service)}
          </div>
          <div class="rating-display-group">
              <span>Ambience & Cleanliness:</span> ${createStars(photoData.ratings.ambience)}
          </div>
          <div class="rating-display-group">
              <span>Value for Money:</span> ${createStars(photoData.ratings.value)}
          </div>
          <div class="rating-display-group overall">
              <span>Overall Experience:</span> ${createStars(photoData.ratings.overall)}
          </div>
      `;
  } else if (photoData.rating) {
      // Fallback for old emoji ratings
      ratingsHTML = `<h4>Rating: <span style="font-size: 1.5rem;">${photoData.rating}</span></h4>`;
  }

  const modal = document.createElement('div');
  modal.className = 'photo-modal';
  modal.style.display = 'block';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3>üì∏ ${photoData.author}'s Experience</h3>
        <button class="modal-close" onclick="this.closest('.photo-modal').remove()">&times;</button>
      </div>
      <div style="padding: 25px 30px 30px;">
        <img src="${photoData.imageUrl}" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 10px; margin-bottom: 20px;">
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
          ${ratingsHTML}
          <h4 style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">Review:</h4>
          <p>${photoData.review}</p>
          <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">Shared on ${photoData.date}</p>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.onclick = e => { if (e.target === modal) modal.remove(); };
}

// Success message
function showSuccessMessage(message) {
  const note = document.createElement('div');
  note.style.cssText = `
    position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
    padding: 15px 25px; border-radius: 10px; z-index: 1001; font-weight: bold;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  `;
  note.textContent = message;
  document.body.appendChild(note);
  setTimeout(() => note.remove(), 3000);
}

// Reset all spots to their placeholder state
function clearBulletinBoard() {
    bulletinPhotos = {}; // Clear the data cache
    for (let i = 1; i <= TOTAL_SPOTS; i++) {
        const spot = document.getElementById(`spot${i}`);
        if (spot) {
            spot.classList.remove('filled');
            spot.innerHTML = `
                <div class="photo-placeholder-spot">
                    <span>üì∑</span>
                    <p>Click to add photo</p>
                </div>
            `;
            // Re-attach the original openPhotoModal listener
            spot.onclick = () => openPhotoModal(i);
        }
    }
}

// Load feedbacks from Firestore (NOW with 7-Day filter)
async function loadFeedbacksFromFirestore() {
  clearBulletinBoard(); // Clear old posts first
  
  try {
    // 1. Calculate the date 7 days ago
    const today = new Date();
    const sevenDaysAgoDate = new Date(today.setDate(today.getDate() - 7));
    const sevenDaysAgoTimestamp = Timestamp.fromDate(sevenDaysAgoDate);

    // 2. Query for approved feedback, ordered by date, newer than 7 days
    const q = query(
        feedbackCollection, 
        where("status", "==", "approved"),
        where("timestamp", ">=", sevenDaysAgoTimestamp),
        orderBy("timestamp", "desc")
    );
    const snapshot = await getDocs(q);

    let spotIndex = 1;
    snapshot.forEach((docSnap) => {
      if (spotIndex > TOTAL_SPOTS) return; // Don't overflow the spots
      
      const data = docSnap.data();
      const image = data.imageUrl;
      
      if (!image) return;

      // --- MODIFICATION: Store 'ratings' object or old 'rating' ---
      bulletinPhotos[spotIndex] = {
        imageUrl: image,
        author: data.name || "Anonymous",
        review: data.comment || "",
        ratings: data.ratings || null, // <-- Store new ratings object
        rating: data.rating || null,   // <-- Store old emoji rating (for fallback)
        date: data.timestamp?.toDate().toLocaleDateString() || "‚Äî"
      };

      updatePhotoSpot(spotIndex, bulletinPhotos[spotIndex]);
      spotIndex++;
    });

    console.log(`‚úÖ Loaded ${snapshot.size} approved feedbacks from the last 7 days.`);
  } catch (error) {
    console.error("‚ùå Error loading feedbacks:", error);
  }
}

// Check auth state
async function checkAuthState() {
    const auth = getAuth();
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                loggedInUser = { uid: user.uid, ...userDoc.data() };
                console.log("User logged in:", loggedInUser);
            }
        } else {
            loggedInUser = null;
            console.log("User logged out.");
        }
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  console.log('Bulletin board initialized');
  checkAuthState();
  loadFeedbacksFromFirestore(); // This now filters for the last 7 days
  
  const authModal = document.getElementById('auth-validation-modal');
    if (authModal) {
        const authModalClose = authModal.querySelector('.auth-modal-close-btn');
        if (authModalClose) {
            authModalClose.addEventListener('click', () => {
                authModal.classList.add('hidden');
            });
        }
    }
    // --- NEW: Add the browser warning ---
  window.addEventListener('beforeunload', (event) => {
      if (hasUnsavedChanges) {
          event.preventDefault();
          event.returnValue = '';
      }
  });

  // --- NEW: Listen for changes in the modal form ---
  const feedbackForm = document.getElementById('photoSubmissionForm');
  if (feedbackForm) {
      feedbackForm.addEventListener('input', () => {
          hasUnsavedChanges = true;
      });
  }
 
});

// Expose functions for HTML onclick
window.openPhotoModal = openPhotoModal;
window.closePhotoModal = closePhotoModal;
window.previewModalPhoto = previewModalPhoto;
window.submitPhotoToBulletin = submitPhotoToBulletin;
window.viewPhotoDetails = viewPhotoDetails;

</script>

<script type="module" src="scripts/firebase.js"></script>
    <script type="module" src="scripts/auth-manager.js"></script>
    <script type="module" src="scripts/notification-manager.js"></script>
    <script type="module" src="scripts/my-account.js"></script> </body>
</body>
</html>